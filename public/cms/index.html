<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>NeoMed Admin</title>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.1.0/dist/decap-cms.js"></script>
  <script>
    // Custom button to run Render Deploy Hook
    const RENDER_DEPLOY_HOOK = 'https://api.render.com/deploy/srv-d5ilgpm3jp1c73c33ol0?key=1GJxMSMivIM';
    const DEPLOY_COOLDOWN_MS = 90000; // 1.5 minutos en milisegundos
    
    // Wait for the CMS to load
    window.addEventListener('load', () => {
      setTimeout(() => {
        const deployButton = document.createElement('button');
        deployButton.textContent = 'üöÄ Deploy a Producci√≥n';
        deployButton.style.cssText = `
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: #10b981;
          color: white;
          border: none;
          padding: 14px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          font-size: 14px;
          transition: all 0.2s;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
          z-index: 9999;
        `;
        
        // Check if there is active cooldown when loading
        function checkCooldown() {
          const lastDeployTime = localStorage.getItem('lastDeployTime');
          if (lastDeployTime) {
            const elapsed = Date.now() - parseInt(lastDeployTime);
            const remaining = DEPLOY_COOLDOWN_MS - elapsed;
            
            if (remaining > 0) {
              // Still on cooldown
              deployButton.disabled = true;
              deployButton.style.cursor = 'not-allowed';
              deployButton.style.background = '#6b7280';
              
              // Update text with countdown
              const updateCountdown = () => {
                const remainingNow = DEPLOY_COOLDOWN_MS - (Date.now() - parseInt(lastDeployTime));
                if (remainingNow > 0) {
                  const seconds = Math.ceil(remainingNow / 1000);
                  deployButton.textContent = `‚è≥ Espera ${seconds}s`;
                  setTimeout(updateCountdown, 1000);
                } else {
                  // Cooldown over
                  deployButton.disabled = false;
                  deployButton.style.cursor = 'pointer';
                  deployButton.style.background = '#10b981';
                  deployButton.textContent = 'üöÄ Deploy a Producci√≥n';
                }
              };
              updateCountdown();
              
              return true; // In cooldown
            }
          }
          return false; // Not in cooldown
        }
        
        // Check initial cooldown
        checkCooldown();
        
        deployButton.onmouseover = () => {
          if (!deployButton.disabled) {
            deployButton.style.background = '#059669';
            deployButton.style.transform = 'translateY(-2px)';
            deployButton.style.boxShadow = '0 6px 16px rgba(16, 185, 129, 0.4)';
          }
        };
        deployButton.onmouseout = () => {
          if (!deployButton.disabled) {
            deployButton.style.background = '#10b981';
            deployButton.style.transform = 'translateY(0)';
            deployButton.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
          }
        };
        
        deployButton.onclick = async () => {
          if (RENDER_DEPLOY_HOOK === 'TU_DEPLOY_HOOK_URL_AQUI') {
            alert('‚ö†Ô∏è Configura el RENDER_DEPLOY_HOOK en public/cms/index.html primero');
            return;
          }
          
          // Check cooldown before proceeding
          if (checkCooldown()) {
            alert('‚è≥ Por favor espera. Se puede hacer deploy cada 1.5 minutos.');
            return;
          }
          
          if (!confirm('¬øDesplegar cambios a producci√≥n?\n\nPor favor verifica que todos los cambios est√©n listos.')) {
            return;
          }
          
          deployButton.disabled = true;
          deployButton.textContent = '‚è≥ Desplegando...';
          deployButton.style.background = '#6b7280';
          deployButton.style.cursor = 'not-allowed';
          
          try {
            // Use no-cors because Render does not return CORS headers
            await fetch(RENDER_DEPLOY_HOOK, { 
              method: 'POST',
              mode: 'no-cors' // We cannot read the response, but the request is sent
            });
            
            // Save deploy timestamp
            localStorage.setItem('lastDeployTime', Date.now().toString());
            
            // If there is no network error, we assume success
            deployButton.textContent = '‚úÖ Deploy iniciado';
            deployButton.style.background = '#10b981';
            
            // Start cooldown
            setTimeout(() => {
              checkCooldown(); // This will start the countdown
            }, 2000);
            
            alert('‚úÖ Deploy iniciado!\n\nEl sitio se actualizar√° en unos minutos.\n\nPodr√°s hacer otro deploy en 1.5 minutos.');
            
          } catch (error) {
            // Only enters here if there is a network error (no internet, incorrect URL, etc)
            deployButton.textContent = '‚ùå Error';
            deployButton.style.background = '#ef4444';
            setTimeout(() => {
              deployButton.textContent = 'üöÄ Deploy a Producci√≥n';
              deployButton.style.background = '#10b981';
              deployButton.style.cursor = 'pointer';
              deployButton.disabled = false;
            }, 3000);
            alert('‚ùå Error de red. Verifica tu conexi√≥n.');
          }
        };
        
        document.body.appendChild(deployButton);
      }, 1000);
    });
  </script>
</body>
</html>
